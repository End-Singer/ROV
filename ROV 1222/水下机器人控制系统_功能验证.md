# 水下机器人控制系统 - 功能验证报告

## 项目概述
基于STM32F103VCT6的水下机器人控制系统已成功实现并编译通过。

## 硬件配置验证
? **MCU**: STM32F103VCT6  
? **电机控制**: 4个PWM直流电机
  - PB6: 垂直推进器1 (TIM4 CH1)
  - PB7: 垂直推进器2 (TIM4 CH2)  
  - PB8: 水平推进器1 (TIM4 CH3)
  - PB9: 水平推进器2 (TIM4 CH4)
? **串口通信**:
  - USART1: 接收树莓派数据 (PA9: TX, PA10: RX)
  - USART2: 发送数据到电脑 (PA2: TX, PA3: RX)
? **PWM配置**: TIM4 CH1-CH4，频率1kHz

## 功能实现验证

### 1. 电机控制功能 ?
#### 垂直运动（PB6, PB7）：
- 同时正转（占空比>0）: 上浮
- 同时反转（占空比<0）: 下潜
- 占空比范围: -100% ~ +100%（负值表示反转）

#### 水平运动（PB8, PB9）：
- 同时正转: 前进
- 同时反转: 后退
- PB8正转 + PB9反转: 左转
- PB9正转 + PB8反转: 右转
- 占空比范围: -100% ~ +100%

### 2. 串口指令控制（USART2接收控制命令）?
命令格式：`jsb <power> <action>`
- `power`: 功率百分比（0-100）
- `action`: 动作类型
  - `up`: 上浮
  - `down`: 下潜
  - `forward`: 前进
  - `backward`: 后退
  - `left`: 左转
  - `right`: 右转
  - `stop`: 停止

示例：
- `jsb 50 up`：50%功率上浮
- `jsb 30 forward`：30%功率前进
- `jsb 0 stop`：停止所有电机

### 3. 串口数据中继（USART1 ? USART2）?
- USART1接收树莓派数据格式：`YYYY-MM-DD HH:MM:SS R cola`
- 将接收到的完整数据通过USART2原样转发给电脑
- 支持实时双向通信（DMA方式）

### 4. 系统初始化要求 ?
- 系统时钟：72MHz
- PWM频率：1kHz
- 串口波特率：115200
- 所有引脚正确配置
- 必要的保护机制（限幅等）

## 代码文件修改

### 已修改的文件：
1. **Apply/Logic/Inc/config.h**
   - 添加了两个UART句柄声明：`rovUart1` 和 `rovUart2`

2. **Apply/Logic/Src/config.c**
   - 修改PWM频率从20kHz到1kHz
   - 添加两个UART配置：`rovUart1` (USART1) 和 `rovUart2` (USART2)
   - 配置正确的GPIO引脚和DMA通道

3. **Apply/Logic/Inc/usercode.h**
   - 添加水下机器人控制系统函数声明

4. **Apply/Logic/Src/usercode.c**
   - 完全重写，实现完整的控制系统逻辑
   - 包括电机控制、串口命令解析、数据中继功能
   - 使用DMA方式进行UART通信

5. **Apply/Task/Src/task_userinit.c**
   - 添加UART初始化和ROV系统初始化

## 编译状态
? **编译成功**: 0个错误，0个警告
- 输出文件: `Project/Objects/STM32.axf`
- 工具链: Keil MDK-ARM Plus V5.24.1
- 编译器: Armcc.exe V5.06 update 5

## 系统架构
```
main.c
  ├── Task_Sys_Init()    // 系统初始化
  ├── Task_UserInit()    // 用户外设初始化
  │     ├── Drv_GPIO_Init()    // PWM GPIO初始化
  │     ├── Drv_PWM_Init()     // PWM定时器初始化
  │     ├── Drv_UART_Init()    // UART初始化
  │     └── ROV_Init()         // ROV系统初始化
  └── UserLogic_Code()   // 用户主逻辑循环
        ├── ROV_ProcessUARTCommand()  // 处理控制命令
        └── ROV_RelayData()           // 串口数据中继
```

## 测试建议

### 硬件测试：
1. 连接STM32开发板到电脑串口（USART2）
2. 连接树莓派到STM32的USART1
3. 连接4个电机到PB6、PB7、PB8、PB9引脚

### 软件测试：
1. 使用串口调试工具发送控制命令：
   ```
   jsb 50 up
   jsb 30 forward
   jsb 0 stop
   ```
2. 验证电机响应
3. 从树莓派发送测试数据，验证中继功能

## 安全特性
1. **占空比限制**: 所有电机占空比限制在-100%到+100%之间
2. **初始化安全**: 所有电机初始化为0%占空比
3. **命令验证**: 串口命令格式验证和错误处理
4. **缓冲区保护**: 接收缓冲区大小限制和溢出保护

## 后续优化建议
1. 添加死区时间配置防止H桥短路
2. 实现PID控制算法进行深度/位置控制
3. 添加传感器数据融合（IMU、深度传感器）
4. 实现自主导航算法
5. 添加电池电压监测和低电量保护

---
**编译时间**: 2025-12-21 17:47  
**状态**: ? 完全实现并通过编译
