# HDU-ROV Embedded Control System (STM32)

> **项目名称**：杭州电子科技大学水下机器人社团 - 深蓝创客杯 ROV嵌入式电控系统  
> **核心芯片**：STM32 (基于 HAL 库开发)  
> **当前版本**：v1.0 (Release 1226)  
> **维护者**：[您的名字/ID]

## 📖 项目简介 | Project Overview

本项目为 **HDU 水下机器人社团** 参加 **深蓝创客杯** 比赛所开发的 ROV（水下机器人）嵌入式控制系统源码。

项目包含 STM32 下位机固件与 PC 端上位机控制软件。系统主要基于 **江科大（Jiang Ke Da）STM32 教程** 进行二次开发与架构迁移（由标准库迁移至 **HAL 库**），实现了 ROV 的六自由度运动控制、机械臂作业以及视觉数据的透传通信。

### ✨ 核心功能
* **多维运动控制**：支持 ROV 前进、后退、上浮、下潜、左转、右转等全向运动。
* **作业控制**：通过 PWM 驱动舵机，精确控制机械爪进行水下物品抓取。
* **视觉算法联动**：通过 USART 串口接收树莓派（Raspberry Pi）运行 YOLO 算法的识别结果，并透传至上位机显示。
* **人机交互系统**：
    * 支持 Xbox 手柄遥控（通过 Python 上位机解析）。
    * 实时回传底层传感器及视觉识别状态。

---

## 📂 目录结构说明 | Directory Structure

项目文件结构包含了开发过程中的迭代版本、单元测试模块以及最终交付代码。

```text
End-Singer/
├── 📂 .idea/                   # IDE 配置文件
├── 📂 ROV 1226/                # 【Release】最终版下位机固件 (已验证/实物烧录版本)
├── 📂 ROV 1221 - 1225/         # 【History】历史迭代版本 (按日期归档)
├── 📂 TIM_PWM/                 # [Driver] PWM 输出驱动单元测试 (电机/舵机测试)
├── 📂 SGA_LED/                 # [Driver] GPIO 与指示灯状态机测试
├── 📂 9-2 串口发送+接收/         # [Driver] USART 基础通信实验
├── 📂 9-4 串口收发文本数据包/     # [Driver] USART 数据包解析协议实验
├── 📄 上位机 1225.py            # 【Host】主要上位机程序 (Xbox控制 + 数据回传显示)
├── 📄 上位机 1224.py            # 【Host】上位机测试版
├── 📂 手柄上位机/               # [Legacy] 往届学长提供的上位机 (不适配当前HAL库协议，仅作参考)
└── 📂 串口助手/                 # [Tools] 江科大提供的标准调试工具

🛠️ 技术架构 | Technical Architecture
1. 下位机 (MCU Firmware)
开发环境：Keil MDK-ARM

硬件平台：STM32F103 系列

软件架构：

基于 STM32 HAL 库 开发，提高移植性与外设配置效率。

运动学解算：将上层指令解析为 4~6 个推进器的 PWM 占空比信号。

通信协议：自定义不定长数据帧，通过 USART 中断方式处理数据包。

2. 上位机 (Host Computer)
开发语言：Python 3.x

依赖库：pyserial (串口通信), pygame/inputs (手柄读取)

功能逻辑：

控制流：读取 Xbox 手柄模拟量/按键 -> 封装为自定义协议帧 -> 通过串口发送至 STM32。

数据流：监听串口 -> 解析 ROV 返回的 YOLO 识别结果/传感器数据 -> 终端/GUI 显示。

⚠️ 关于兼容性的说明： 文件夹内的 手柄上位机 为旧版程序，由于本项目底层已重构为 HAL 库且修改了通信协议头/校验位，故旧版上位机无法直接控制当前 ROV。请务必使用 上位机 1225.py 进行联调。
------------------------------------------------------------------------------------------------------------------------------------------------------------------------
🚀 快速开始 | Quick Start
硬件连接
通信链路：使用 USB-TTL 模块连接 PC 与 STM32 的 USART1 接口（TX-RX, RX-TX, GND-GND）。

树莓派连接：树莓派 TX/RX 连接至 STM32 指定 USART 接口（用于 YOLO 数据透传）。

外设供电：确保电机驱动板与 STM32 供电正常。

烧录与运行
下位机：

使用 Keil 打开 📂 ROV 1226 目录下的工程文件。

编译并下载代码至 STM32 开发板。

注：ROV 1226 经过完整水下测试，为推荐稳定版本。

上位机：

连接 Xbox 手柄至电脑。

安装 Python 依赖：pip install pyserial pygame

运行脚本：

Bash
python "上位机 1225.py"
程序启动后将自动搜索串口并尝试连接手柄。
------------------------------------
📡 通信协议摘要 | Protocol Summary为了确保水下环境通信的稳定性，本项目采用了自定义的数据包结构：
帧头,数据载荷 (Payload),帧尾
[,Data1 ... DataN,]

控制指令 (PC -> ROV)：包含摇杆 X/Y/Z 轴数据及按键状态。

回传数据 (ROV -> PC)：包含 YOLO 识别到的目标类别 ID 及置信度。
